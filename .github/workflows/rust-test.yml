name: Build and test

on:
  push:
  pull_request:
    branches: [ "master", "dev" ]

env:
  CARGO_TERM_COLOR: always
  # See https://rustmagazine.org/issue-2/optimize-rust-comptime/#step-3:-disable-incremental-compilation
  CARGO_INCREMENTAL: 0
  RUST_BACKTRACE: 1

jobs:
  test:
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        # Tests MSRV and the latest stable.
        rust-version: ["1.74", "stable"]
    steps:
    - name: Set up required tools
      run: |
        sudo apt-get update \
          && sudo apt-get install curl build-essential -y
    - name: "Checkout repository"
      uses: actions/checkout@v4.1.1
    - name: "Install Rust"
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust-version }}
    - name: "Set up cache"
      uses: Swatinem/rust-cache@v2
    - name: "Build fs-more"
      run: cargo build -p fs-more --lib --all-features
    - name: "Build tests"
      run: cargo build --tests --all-features
    - name: "Build all"
      run: cargo build --all-targets --all-features
    - name: Run doctests
      run: cargo test --workspace --doc --all-features
    - name: "Install nextest"
      uses: taiki-e/install-action@v2
      with:
        tool: nextest@0.9.70
    - name: Run tests
      run: cargo nextest run --color always --workspace --all-targets --all-features --no-fail-fast
